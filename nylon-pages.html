<link rel="import" href="../polymer/polymer.html">
<script src="../page/page.js"></script>

<dom-module id="nylon-pages">
  <template>
    <style>
       :host {
        display: block;
      }

       :host> ::slotted(:not(.iron-selected)) {
        display: none !important;
      }
    </style>
    <slot></slot>
  </template>

  <script>
    /**
     * `nylon-pages`
     * Router Component.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    Polymer({
      is: 'nylon-pages',
      properties: {
        attrForSelected: {
          type: String,
          value: 'name'
        },
        attrForPath: {
          type: String,
          value: 'path'
        },
        selectedAttribute: {
          type: String,
          value: 'visible'
        },
        selected: {
          type: String,
          notify: true
        },
        role: {
          type: Array,
          value: [],
          notify: true
        }
      },
      ready: function () {
        if(this.getAttribute('manual')==null){
          this._initRoute()
        }
      },
      start(option){
        //console.log(option)
       this._initRoute(option)
      },
      _initRoute: function (option) {

        var option = option || {}
        
        for (let i = 0; i < this.children.length; i++) {


          var preRole = { page: this.children[i].localName }
          if (this.children[i].getAttribute('role') != null) {
            preRole.role = this.children[i].getAttribute('role')
          }
          this.push('role', preRole)


          //join path
          var rootPattern = option.rootPattern || ''

          if(rootPattern!=''){
            if(rootPattern[rootPattern.length-1]=='/'){
              rootPattern = rootPattern.substring(0,rootPattern.length-1)
            }
          }

          this.rootPattern = rootPattern

          var elementPath = this.children[i].getAttribute(this.attrForPath)
          if(elementPath[0]!='/'){
            elementPath = '/'+elementPath
          }
          
          //router
          page(rootPattern+elementPath, (ctx, next) => {

            var detail = {
              ctx,
              next,
              page,
              path: ctx.path,
              redirect: (path) => {
                if(path[0]!='/'){
                  path = '/'+path
                }
                page.redirect(rootPattern+path)
              },
              element: this.children[i],
              selected: this.children[i].getAttribute(this.attrForSelected),
              params: ctx.params,
              index: i,
              pass: () => {
                //if pass,It wii be show element.
                this._reflectChildrenAttribute(i)
                this.selected = this.children[i].getAttribute(this.attrForSelected)
                this.children[i]._params = ctx.params
                this.async(function () {
                  this.fire('nylon-pages-changed', detail)
                }, 1)

              },
              active:()=>{
                //if want to call function nylonPagesActive and nylonPagesUnActive of children element.
                if(this.currentPage){
                  if(this.currentPage.nylonPagesUnActive){
                    this.currentPage.nylonPagesUnActive(detail)
                  }
                }
                this.currentPage = detail.element
                if(this.currentPage.nylonPagesActive){
                  this.currentPage.nylonPagesActive(detail)
                }

              }
            }


            if (this.children[i].getAttribute('role') != null) {
              detail.role = this.children[i].getAttribute('role')
              this.async(() => {
                this.fire('nylon-pages-role', detail)
              }, 1)
            } else {
              detail.pass()
            }

          });
        }
        page()
      },
      _reflectChildrenAttribute: function (index) {
        // console.log(this.children[index].localName)
        for (let i = 0; i < this.children.length; i++) {
          this.children[i].removeAttribute(this.selectedAttribute)
          this.children[i].setAttribute("class", "x-scope " + this.children[index].localName + "-0")
        }

        this.children[index].setAttribute(this.selectedAttribute, true)
        this.children[index].setAttribute("class", "x-scope " + this.children[index].localName + "-0 " + "iron-selected")
      },
      redirect: function(path){
        //console.log(path[0]=='/')
        if(path[0]!='/'){
          path = '/'+path
        }
        page.redirect(this.rootPattern+path)
      }
    });
  </script>
</dom-module>